<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">x_aposteriori</span>,<span class="var type1" id="S3T9U4">P_aposteriori</span>] = positionKalmanFilter1D(<span class="var type1" id="S4T1U7">x_aposteriori_k</span>,<span class="var type1" id="S5T9U8">P_aposteriori_k</span>,<span class="var type1" id="S6T8U9">velocity_observe</span>,<span class="var type1" id="S7T8U10">gps_update</span>,<span class="var type1" id="S8T2U11">acc</span>,<span class="var type1" id="S9T1U12">z</span>,<span class="var type1" id="S10T1U13">sigma</span>,<span class="var type1" id="S11T1U14">q</span>,<span class="var type1" id="S12T2U15">dt</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% Kalman Filter for Position Estimator from Acc + GPS</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">% state_vector x_aposteriori_k = [pos vel]'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">% P_aposteriori_k = P</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">% velocitiy_observe = vo</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">% gps_update = u</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">% acc = a</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="comment">% z = [pos_meas vel_meas]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"><span class="comment">% sigma = [sigma1 sigma2]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"><span class="comment">% q = [q(1) q(2)]'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line"><span class="comment">% dt</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line"><span class="comment">% $Author: Damian Aregger $    $Date: 2012 $    $Revision: 1 $</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line">    <span class="comment">% process noise variance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line">    <span class="mxinfo" id="T9:U12"><span class="var type1" id="S13T9U18">Q</span> = <span class="mxinfo" id="T9:U14">[<span class="mxinfo" id="T22:U15"><span class="mxinfo" id="T2:U16"><span class="mxinfo" id="T2:U17"><span class="mxinfo" id="T2:U18"><span class="var type1" id="S11T1U24">q</span>(<span class="mxinfo" id="T3:U20">1</span>)</span>^2</span>*<span class="var type1" id="S12T2U27">dt</span></span> <span class="mxinfo" id="T3:U22">0</span></span>; <span class="mxinfo" id="T22:U23"><span class="mxinfo" id="T3:U24">0</span> <span class="mxinfo" id="T2:U25"><span class="mxinfo" id="T2:U26"><span class="mxinfo" id="T2:U27"><span class="var type1" id="S11T1U34">q</span>(<span class="mxinfo" id="T3:U29">2</span>)</span>^2</span>*<span class="var type1" id="S12T2U37">dt</span></span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line">    <span class="comment">% measurement noise variance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line">    <span class="mxinfo" id="T9:U31"><span class="var type1" id="S14T9U40">R</span> = <span class="mxinfo" id="T9:U33">[<span class="mxinfo" id="T22:U34"><span class="mxinfo" id="T2:U35"><span class="mxinfo" id="T2:U36"><span class="var type1" id="S10T1U45">sigma</span>(<span class="mxinfo" id="T3:U38">1</span>)</span>^2</span> <span class="mxinfo" id="T3:U39">0</span></span>; <span class="mxinfo" id="T22:U40"><span class="mxinfo" id="T3:U41">0</span> <span class="mxinfo" id="T2:U42"><span class="mxinfo" id="T2:U43"><span class="var type1" id="S10T1U53">sigma</span>(<span class="mxinfo" id="T3:U45">2</span>)</span>^2</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line">    <span class="comment">% system description</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line">    <span class="mxinfo" id="T9:U46"><span class="var type1" id="S15T9U58">A</span> = <span class="mxinfo" id="T9:U48">[<span class="mxinfo" id="T22:U49"><span class="mxinfo" id="T3:U50">1</span> <span class="var type1" id="S12T2U62">dt</span></span>; <span class="mxinfo" id="T23:U52"><span class="mxinfo" id="T3:U53">0</span> <span class="mxinfo" id="T3:U54">1</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line">    <span class="mxinfo" id="T1:U55"><span class="var type1" id="S16T1U68">B</span> = <span class="mxinfo" id="T1:U57"><span class="mxinfo" id="T22:U58">[<span class="mxinfo" id="T3:U59">0</span> <span class="var type1" id="S8T2U73">acc</span>]</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line">    <span class="comment">% decide if velocity can be observed</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U61"><span class="var type1" id="S6T8U77">velocity_observe</span> == <span class="mxinfo" id="T3:U63">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line">        <span class="mxinfo" id="T14:U64"><span class="var type1" id="S17T14U81">H</span> = <span class="mxinfo" id="T14:U66">[<span class="mxinfo" id="T23:U67"><span class="mxinfo" id="T3:U68">1</span> <span class="mxinfo" id="T3:U69">0</span></span>; <span class="mxinfo" id="T23:U70"><span class="mxinfo" id="T3:U71">0</span> <span class="mxinfo" id="T3:U72">0</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line">        <span class="mxinfo" id="T14:U73"><span class="var type1" id="S17T14U92">H</span> = <span class="mxinfo" id="T14:U75">[<span class="mxinfo" id="T23:U76"><span class="mxinfo" id="T3:U77">1</span> <span class="mxinfo" id="T3:U78">0</span></span>; <span class="mxinfo" id="T23:U79"><span class="mxinfo" id="T3:U80">0</span> <span class="mxinfo" id="T3:U81">1</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line">    <span class="comment">%% Main Filter step</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">    <span class="comment">%Step 1 prediction/a priori</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line">    <span class="mxinfo" id="T1:U82"><span class="var type1" id="S18T1U102">x_apriori</span> = <span class="mxinfo" id="T1:U84"><span class="mxinfo" id="T1:U85"><span class="var type1" id="S15T9U105">A</span>*<span class="var type1" id="S4T1U106">x_aposteriori_k</span></span>+<span class="var type1" id="S16T1U107">B</span></span></span>;                 <span class="comment">%project state ahead</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line">    <span class="mxinfo" id="T9:U89"><span class="var type1" id="S19T9U110">P_apriori</span> = <span class="mxinfo" id="T9:U91"><span class="mxinfo" id="T9:U92"><span class="mxinfo" id="T9:U93"><span class="var type1" id="S15T9U114">A</span>*<span class="var type1" id="S5T9U115">P_aposteriori_k</span></span>*<span class="mxinfo" id="T9:U96"><span class="var type1" id="S15T9U117">A</span>'</span></span>+<span class="var type1" id="S13T9U118">Q</span></span></span>;                    <span class="comment">%project error covariance ahead</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line">    <span class="comment">%Step 2 correction/a posteriori</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo" id="T6:U99"><span class="var type1" id="S7T8U122">gps_update</span> == <span class="mxinfo" id="T3:U101">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line">        <span class="mxinfo" id="T9:U102"><span class="var type1" id="S20T9U126">K</span> = <span class="mxinfo" id="T9:U104"><span class="mxinfo" id="T9:U105"><span class="var type1" id="S19T9U129">P_apriori</span>*<span class="mxinfo" id="T14:U107"><span class="var type1" id="S17T14U131">H</span>'</span></span>*<span class="mxinfo" id="T9:U109">inv(<span class="mxinfo" id="T9:U110"><span class="mxinfo" id="T9:U111"><span class="mxinfo" id="T9:U112"><span class="var type1" id="S17T14U137">H</span>*<span class="var type1" id="S19T9U138">P_apriori</span></span>*<span class="var type1" id="S17T14U139">H</span></span>+<span class="var type1" id="S14T9U140">R</span></span>)</span></span></span>;              <span class="comment">%compute kalman gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line">        <span class="mxinfo" id="T1:U117"><span class="var type1" id="S2T1U143">x_aposteriori</span> = <span class="mxinfo" id="T1:U119"><span class="var type1" id="S18T1U145">x_apriori</span>+<span class="mxinfo" id="T1:U121"><span class="var type1" id="S20T9U147">K</span>*(<span class="mxinfo" id="T1:U123"><span class="var type1" id="S9T1U150">z</span>-<span class="mxinfo" id="T1:U125"><span class="var type1" id="S17T14U152">H</span>*<span class="var type1" id="S18T1U153">x_apriori</span></span></span>)</span></span></span>;        <span class="comment">%update estimate via z</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">        <span class="mxinfo" id="T9:U128"><span class="var type1" id="S3T9U156">P_aposteriori</span> = <span class="mxinfo" id="T9:U130">(<span class="mxinfo" id="T9:U131"><span class="mxinfo" id="T14:U132">eye(2)</span>-<span class="mxinfo" id="T9:U133"><span class="var type1" id="S20T9U164">K</span>*<span class="var type1" id="S17T14U165">H</span></span></span>)*<span class="var type1" id="S19T9U166">P_apriori</span></span></span>;           <span class="comment">%update error covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line">       <span class="mxinfo" id="T1:U137"><span class="var type1" id="S2T1U170">x_aposteriori</span> = <span class="var type1" id="S18T1U171">x_apriori</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line">       <span class="mxinfo" id="T9:U140"><span class="var type1" id="S3T9U174">P_aposteriori</span> = <span class="var type1" id="S19T9U175">P_apriori</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line">    <span class="keyword">end</span>  </span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
